<!DOCTYPE html>
<html lang="en">

<head>
    <title>WebPushDemo</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="image/WP.png">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>

<body>
        <div class="jumbotron text-center" style="margin-bottom:0">
                <h1>Web Notifications Test</h1>
                <p>This is a page to help you to test your browser's sopport for HTML5 Web Notifications. </p>
            </div>
        
            <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
                <a class="navbar-brand" href="#">WEB PUSH</a>
                <div class="collapse navbar-collapse" id="collapsibleNavbar">
                    <ul class="navbar-nav">
                        <li class="nav-item" id="gettoken">
                            <a class="nav-link" href="#">获取设备标识</a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <div>
                <div class="container" style="margin-top:30px" >
                    <button type="button" class="btn btn-outline-dark" onclick="onBtnGetToken()">Get Token</button>
                    <button type="button" class="btn btn-outline-dark" onclick="onBtnDeleteToken()">Delete Token</button>
                    <button type="button" class="btn btn-outline-dark" onclick="onBtnGetAndDeleteToken()">Get and Delete Token</button>
                    <p id="token" style="margin-top:30px">Message here</p>
                </div>
                <div class="jumbotron text-center" style="margin-bottom: 0px;margin-top: 415px;padding-top: 40px;padding-bottom: 40px;">
                    <p>At the time writing,they are supported by the latest versions of Firefox(v22).Chrome(v27) and Safari(v6.05). </p>
                </div>
            </div>
    <script src="https://push-static.dbankcdn.com/hms-messaging.js"></script>
    <script>

        var hmsConfig = {
            apiKey: "_fCXdESSSpjs5z7vYb2GcU1_6C8BEQ9tdJVUQaBu",
            appId: "101249565"
        };
        
        hms.initializeApp(hmsConfig);

        const messaging = hms.messaging();
        messaging.usePublicVapidKey("BJQrfdgOUDshvcw0poCUpWukxIHHU3jFMWgzneSG9WUCYk86AvUHqx70DFH_LbuV94ECOWB8vrZ321YHD4LmJBM");
        messaging.onMessage((payload) => {
            console.log('Message received. ', payload);
			alert('Message received. ', payload);
            // ...
        });

        function onBtnGetToken() {
            Notification.requestPermission().then((permission) => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
					alert('Notification permission granted.');
                    getToken();
                } else {
                    console.log('Unable to get permission to notify.');
					alert('Unable to get permission to notify.');
                }
            }).catch((err) => {
                console.log('An error occurred while onBtnGetToken . ', err);
				alert('An error occurred while onBtnGetToken . ', err);
            });
			
        }

        function onBtnDeleteToken() {
            messaging.getToken().then((currentToken) => {
			    console.log('Current token: ', currentToken);
                document.getElementById("token").innerText = currentToken;
                return messaging.deleteToken(currentToken);
            }).then((success) => {
                console.log('Delete token result: ', success);
                document.getElementById("token").innerText = '';
            });
        }

        let dataMessage ={
            validate_only:false,
            message:{
                webpush:{
                    notification:{
                        title: "inputTitle",
                        body: "inputBody",
                        badge: "string",
                        dir: "auto",
                        icon: "",
                        image: "",
                        },
                        hms_options:{
                            link:""
                        }
                    },
                    token:[]
            }
        }
		
		function onBtnGetAndDeleteToken() {
            messaging.getToken().then((currentToken) => {
			    console.log('Current token: ', currentToken);
                document.getElementById("token").innerText = currentToken;
                return messaging.deleteToken(currentToken);
            }).then((success) => {
                console.log('Delete token result: ', success);
                document.getElementById("token").innerText = '';
            });
        }
		

        function getToken() {
            messaging.getToken().then((currentToken) => {
                if (currentToken) {
                    console.log('Current token: ', currentToken);
                    document.getElementById("token").innerText = currentToken;
                    var current = [currentToken]
                    //dataMessage.message.token = current;
					alert('getToken Success.');
                } else {
                    console.log('No Instance ID token available. Request permission to generate one.');
					alert('No Instance ID token available. Request permission to generate one.');
                }
            }).catch((err) => {
                console.log('An error occurred while retrieving token. ', err);
				alert('An error occurred while retrieving token. err is '+ err);
            });
        }
         navigator.serviceWorker.register("hms-messaging-sw.js", {
             scope: "./hms-cloud-messaging-push-scope"
         }).then((registration) => {
            alert('registration')
            messaging.useServiceWorker(registration);
         })
    </script>
</body>

</html>
